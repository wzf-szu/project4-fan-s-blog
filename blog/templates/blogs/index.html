{% extends 'blogs/base.html' %}
{% load static %}
{% block content %}
<section class="hero-banner reveal">
            <div class="banner-track" id="banner-track" style="position: absolute; inset: 0; z-index: 0;">
                {% if hero_posts %}
                    {% for hp in hero_posts %}
                    <div class="banner-slide{% if forloop.first %} active{% endif %}" data-bg="{{ hp.cover_url }}"></div>
                    {% endfor %}
                {% else %}
                    <div class="banner-slide active" data-bg="{% static 'assets/desktop-banner/1.webp' %}"></div>
                    <div class="banner-slide" data-bg="{% static 'assets/desktop-banner/2.webp' %}"></div>
                    <div class="banner-slide" data-bg="{% static 'assets/desktop-banner/3.webp' %}"></div>
                    <div class="banner-slide" data-bg="{% static 'assets/desktop-banner/4.webp' %}"></div>
                    <div class="banner-slide" data-bg="{% static 'assets/desktop-banner/5.webp' %}"></div>
                    <div class="banner-slide" data-bg="{% static 'assets/desktop-banner/6.webp' %}"></div>
                {% endif %}
            </div>

            <div class="banner-overlay" style="z-index: 1;">
                <div class="overlay-card">
                    <p class="eyebrow">hometown.sailing</p>
                    <h1 class="typewriter" data-phrases="特別なことはないけど、君がいると十分です|今でもあなたは私の光|君ってさ、知らないうちに私の毎日になってたよ|君と話すと、なんか毎日がちょっと楽しくなるんだ|今日はなんでもない日。でも、ちょっとだけいい日"></h1>
                </div>
            </div>
        </section>

<div class="layout" style="--hero-wallpaper: url('{% static 'assets/home/home.png' %}')">
    <div class="main-col">
        <div class="timeline">
            {% for post in posts %}
            <div class="post-card reveal {% if post.cover_url %}has-cover{% endif %}">
                <div class="post-card-content">
                    <a href="{% url 'blogs:post_detail' post.slug %}" class="post-card-title">{{ post.title }}</a>
                    
                    <div class="post-card-meta">
                        <span>{{ post.date_added|date:'Y-m-d' }}</span>
                        <span>·</span>
                        <span>{{ post.word_count }} words</span>
                        <span>·</span>
                        <span>{{ post.owner.username }}</span>
                    </div>

                    <div class="post-card-desc">
                        {{ post.summary|default:post.text|truncatechars:140 }}
                    </div>

                    <div class="post-card-tags">
                        {% for tag in post.tags.all %}
                            <a href="{% url 'blogs:index' %}?tag={{ tag.slug }}" class="tag-btn"># {{ tag.name }}</a>
                        {% empty %}
                            <!-- No tags -->
                        {% endfor %}
                    </div>
                </div>

                {% if post.cover_url %}
                <a href="{% url 'blogs:post_detail' post.slug %}" class="post-card-cover">
                    <img src="{{ post.cover_url }}" alt="{{ post.title }}" loading="lazy">
                </a>
                {% endif %}
            </div>
            {% empty %}
            <div class="post-card reveal">
                <div class="post-card-content">
                    <h3 class="post-card-title">No posts yet.</h3>
                    <p class="post-card-desc">Log in to write your first post.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <aside class="sidebar">
        <!-- Profile Card -->
        <div class="card-base profile-card reveal">
            <a href="{% url 'blogs:index' %}" class="profile-avatar-link" aria-label="About">
                <div class="avatar-overlay">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <img src="{% static 'assets/avatar.webp' %}" alt="Mizuki" class="profile-avatar">
            </a>
            <div class="profile-info">
                <div class="profile-name">fan blog</div>
                <div class="profile-divider"></div>
                <div class="profile-bio">A Django blog with Mizuki UI.</div>
                <div class="profile-links">
                    <a href="#" class="btn-regular icon-btn rounded-lg" aria-label="GitHub">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                    </a>
                    <a href="#" class="btn-regular icon-btn rounded-lg" aria-label="Twitter">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card-base sidebar-card reveal">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                <span class="card-title">Quick Actions</span>
            </div>
            <div class="card-body">
                <div class="quick-actions-grid">
                    {% if user.is_authenticated %}
                        <a class="action-btn" href="{% url 'blogs:new_post' %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            New Post
                        </a>
                        <form action="{% url 'logout' %}" method="post" style="display: contents;">{% csrf_token %}
                            <button type="submit" class="action-btn" style="width: 100%; border: none; cursor: pointer;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                Logout
                            </button>
                        </form>
                    {% else %}
                        <a class="action-btn" href="{% url 'login' %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                            Login
                        </a>
                        <a class="action-btn" href="{% url 'register' %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                            Register
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Site Stats -->
        <div class="card-base sidebar-card reveal">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                <span class="card-title">Site Stats</span>
            </div>
            <div class="card-body">
                <div class="stats-row">
                    <span class="stats-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        Articles
                    </span>
                    <span class="stats-value">{{ total_posts|default:"0" }}</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                        Tags
                    </span>
                    <span class="stats-value">{{ total_tags|default:"0" }}</span>
                </div>
            </div>
        </div>
    </aside>
</div>

<script>
    // 打字机
    (function() {
        const els = document.querySelectorAll('.typewriter');
        els.forEach(el => {
            const phrases = (el.dataset.phrases || '').split('|').filter(Boolean);
            if (!phrases.length) { el.textContent = el.dataset.phrases || el.textContent; return; }
            
            let phraseIndex = 0;
            let charIndex = 0;
            let isDeleting = false;
            let baseTypeSpeed = 65; // Normal typing speed
            let deleteSpeed = 40; // Faster deleting speed
            let pauseEnd = 2000; // Wait at end
            let pauseStart = 500; // Wait before typing next
            let typeSpeed = baseTypeSpeed;

            const tick = () => {
                const currentPhrase = phrases[phraseIndex];
                
                if (isDeleting) {
                    el.textContent = currentPhrase.substring(0, charIndex - 1);
                    charIndex--;
                    typeSpeed = deleteSpeed;
                } else {
                    el.textContent = currentPhrase.substring(0, charIndex + 1);
                    charIndex++;
                    typeSpeed = baseTypeSpeed;
                }

                if (!isDeleting && charIndex === currentPhrase.length) {
                    // Finished typing
                    isDeleting = true;
                    typeSpeed = pauseEnd; // Wait before deleting
                } else if (isDeleting && charIndex === 0) {
                    // Finished deleting
                    isDeleting = false;
                    phraseIndex = (phraseIndex + 1) % phrases.length;
                    typeSpeed = pauseStart; // Wait before typing next
                }

                setTimeout(tick, typeSpeed);
            };
            tick();
        });
    })();

    // 网格/列表切换
    (function() {
        const toggles = document.querySelectorAll('.layout-switch');
        const timeline = document.querySelector('.timeline');
        if (!toggles.length || !timeline) return;
        const updateLabel = () => {
            const isGrid = timeline.classList.contains('grid-mode');
            toggles.forEach(t => {
                const textEl = t.querySelector('.nav-text');
                if (textEl) textEl.textContent = isGrid ? 'List' : 'Grid';
                t.dataset.mode = isGrid ? 'grid' : 'list';
                t.setAttribute('aria-label', isGrid ? '切回列表' : '切换网格');
            });
        };
        toggles.forEach(btn => btn.addEventListener('click', () => {
            timeline.classList.toggle('grid-mode');
            updateLabel();
        }));
        updateLabel();
    })();

    // 封面轮播（英雄 Banner）
    (function() {
        const slides = Array.from(document.querySelectorAll('#banner-track .banner-slide'));
        const globalWallpaper = document.getElementById('global-wallpaper');
        if (!slides.length) return;
        
        let index = 0; let timer; let transitioning = false;
        
        const updateWallpaper = (slide) => {
            if (!globalWallpaper) return;
            // Extract URL from data-bg
            const bg = slide.dataset.bg;
            if (bg) {
                globalWallpaper.style.backgroundImage = `url('${bg}')`;
            }
        };

        const activate = (i) => {
            if (transitioning || i === index) return;
            transitioning = true;
            const nextSlide = slides[i];
            nextSlide.classList.add('active');
            
            // Sync global wallpaper
            updateWallpaper(nextSlide);

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    slides.forEach((s, idx) => { if (idx !== i) s.classList.remove('active'); });
                    index = i;
                    setTimeout(() => { transitioning = false; }, 320);
                });
            });
        };
        
        // Init wallpaper
        updateWallpaper(slides[0]);

        const start = () => { timer = setInterval(() => activate((index + 1) % slides.length), 5200); };
        start();
    })();

    // 日历，带前后月切换和帖子打点
    (function() {
        const el = document.getElementById('mini-calendar');
        const dataNode = document.getElementById('post-dates-data');
        const postDates = dataNode ? JSON.parse(dataNode.textContent) : [];
        if (!el) return;
        let cursor = new Date();
        const render = () => {
            const year = cursor.getFullYear();
            const month = cursor.getMonth();
            const first = new Date(year, month, 1);
            const startDay = first.getDay();
            const days = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const weeks = [];
            let week = new Array(startDay).fill('');
            for (let d = 1; d <= days; d++) {
                week.push(d);
                if (week.length === 7) { weeks.push(week); week = []; }
            }
            if (week.length) weeks.push(week.concat(new Array(7 - week.length).fill('')));
            const html = [
                `<div class="cal-head">${year}年 ${month + 1}月 <button type="button" class="cal-btn" data-dir="-1">←</button><button type="button" class="cal-btn" data-dir="1">→</button></div>`,
                '<div class="cal-grid">',
                '<span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>'
            ];
            weeks.forEach(w => w.forEach(d => {
                const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const iso = d ? `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}` : '';
                const hasPost = iso && postDates.includes(iso);
                const cls = `${isToday ? 'today' : ''} ${hasPost ? 'has-post' : ''}`.trim();
                html.push(`<span class="${cls}">${d || ''}${hasPost ? '<i class="dot"></i>' : ''}</span>`);
            }));
            html.push('</div>');
            el.innerHTML = html.join('');
            el.querySelectorAll('.cal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dir = Number(btn.dataset.dir);
                    cursor = new Date(cursor.getFullYear(), cursor.getMonth() + dir, 1);
                    render();
                });
            });
        };
        render();
    })();

</script>

{{ post_dates|json_script:"post-dates-data" }}
{% endblock %}
